{% extends 'merchant/base.j2' %}

{% block title %}Integration{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Payment Widget Generator</h5>
      </div>
      <div class="card-body">
        <p class="text-muted">Configure your payment button and copy the code below.</p>

        <div class="mb-3">
          <label class="form-label">Amount (USD)</label>
          <input type="number" id="widget-amount" class="form-control" value="99.99" min="0.01" step="0.01">
        </div>

        <div class="mb-3">
          <label class="form-label">Cryptocurrency</label>
          <select id="widget-crypto" class="form-select">
            {% for crypto in cryptos %}
            <option value="{{ crypto }}" {% if crypto == 'BTC' %}selected{% endif %}>{{ crypto }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Button Style</label>
          <select id="widget-style" class="form-select">
            <option value="default">Default (Orange)</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Button Text</label>
          <input type="text" id="widget-text" class="form-control" placeholder="Leave empty for default">
          <small class="text-muted">Default: "Pay $XX.XX"</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Callback URL (Optional)</label>
          <input type="url" id="widget-callback" class="form-control" placeholder="https://your-site.com/webhook">
          <small class="text-muted">Override your default webhook URL for this button</small>
        </div>

        <button class="btn btn-primary" onclick="generateCode()">Generate Code</button>
      </div>
    </div>

    <!-- Quick Integration -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Quick Integration</h5>
      </div>
      <div class="card-body">
        <p>Add these two lines anywhere on your page to enable TorPay:</p>

        <h6 class="mt-3">1. Add the script (once per page)</h6>
        <pre class="bg-dark text-light p-3 rounded" id="script-tag"><code>&lt;script src="{{ base_url }}/static/js/shkeeper-widget.js"&gt;&lt;/script&gt;</code></pre>
        <button class="btn btn-sm btn-outline-primary mb-3" onclick="copyCode('script-tag')">Copy</button>

        <h6>2. Initialize (once per page)</h6>
        <pre class="bg-dark text-light p-3 rounded" id="init-code"><code>&lt;script&gt;
SHKeeper.init({
  apiKey: '{{ merchant.api_key }}',
  baseUrl: '{{ base_url }}'
});
&lt;/script&gt;</code></pre>
        <button class="btn btn-sm btn-outline-primary mb-3" onclick="copyCode('init-code')">Copy</button>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <!-- Preview -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Live Preview</h5>
      </div>
      <div class="card-body text-center" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
        <div id="preview-container"></div>
      </div>
    </div>

    <!-- Generated Code -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Generated Code</h5>
        <button class="btn btn-sm btn-primary" onclick="copyCode('generated-code')">Copy Code</button>
      </div>
      <div class="card-body">
        <pre class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;" id="generated-code"><code><!-- Code will appear here --></code></pre>
      </div>
    </div>

    <!-- Full Page Example -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Complete HTML Example</h5>
      </div>
      <div class="card-body">
        <pre class="bg-dark text-light p-3 rounded" style="font-size: 12px;" id="full-example"><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Checkout - Your Store&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Complete Your Purchase&lt;/h1&gt;
  &lt;p&gt;Order Total: $99.99&lt;/p&gt;

  &lt;!-- TorPay Payment Button --&gt;
  &lt;div id="torpay-button"&gt;&lt;/div&gt;

  &lt;!-- TorPay Widget --&gt;
  &lt;script src="{{ base_url }}/static/js/shkeeper-widget.js"&gt;&lt;/script&gt;
  &lt;script&gt;
    SHKeeper.init({
      apiKey: '{{ merchant.api_key }}',
      baseUrl: '{{ base_url }}'
    });

    SHKeeper.createButton('#torpay-button', {
      amount: 99.99,
      currency: 'USD',
      crypto: 'BTC',
      orderId: 'ORDER-123',

      onPaymentComplete: function(invoice) {
        // Payment received! Redirect to thank you page
        window.location.href = '/thank-you?order=' + invoice.external_id;
      }
    });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
        <button class="btn btn-sm btn-outline-primary" onclick="copyCode('full-example')">Copy Full Example</button>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Options -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Advanced: Programmatic Payments</h5>
      </div>
      <div class="card-body">
        <p>For more control, you can create payments programmatically:</p>

        <pre class="bg-dark text-light p-3 rounded"><code>// Open payment modal directly
document.getElementById('my-checkout-btn').addEventListener('click', function() {
  SHKeeper.openPaymentModal({
    amount: getCartTotal(),           // Dynamic amount from your cart
    currency: 'USD',
    crypto: 'BTC',
    orderId: generateOrderId(),       // Your order ID

    onSuccess: function(invoice) {
      // Payment invoice created
      console.log('Invoice:', invoice.id);
      console.log('Send to:', invoice.dest);
      console.log('Amount:', invoice.amount_crypto, invoice.wallet);
    },

    onPaymentComplete: function(invoice) {
      // Payment received!
      submitOrder(invoice);
    },

    onError: function(error) {
      console.error('Payment failed:', error);
      showError('Payment could not be created. Please try again.');
    }
  });
});

// Or create payment via API and handle UI yourself
SHKeeper.createPayment({
  amount: 99.99,
  currency: 'USD',
  crypto: 'BTC',
  orderId: 'order-123'
}, function(error, invoice) {
  if (error) {
    console.error(error);
    return;
  }
  // Show your own payment UI
  showPaymentAddress(invoice.dest);
  showQRCode(invoice.qr_url);
  startPollingForPayment(invoice.id);
});</code></pre>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/shkeeper-widget.js') }}"></script>
<script>
// Initialize widget
SHKeeper.init({
  apiKey: '{{ merchant.api_key }}',
  baseUrl: '{{ base_url }}'
});

function generateCode() {
  var amount = document.getElementById('widget-amount').value;
  var crypto = document.getElementById('widget-crypto').value;
  var style = document.getElementById('widget-style').value;
  var buttonText = document.getElementById('widget-text').value;
  var callback = document.getElementById('widget-callback').value;

  var options = {
    amount: parseFloat(amount),
    currency: 'USD',
    crypto: crypto
  };

  if (buttonText) options.buttonText = buttonText;
  if (callback) options.callbackUrl = callback;

  // Generate code
  var code = `<!-- TorPay Payment Button -->
<div id="torpay-button"></div>

<script src="{{ base_url }}/static/js/shkeeper-widget.js"><\/script>
<script>
SHKeeper.init({
  apiKey: '{{ merchant.api_key }}',
  baseUrl: '{{ base_url }}'
});

SHKeeper.createButton('#torpay-button', {
  amount: ${amount},
  currency: 'USD',
  crypto: '${crypto}'${buttonText ? `,
  buttonText: '${buttonText}'` : ''}${callback ? `,
  callbackUrl: '${callback}'` : ''},

  onPaymentComplete: function(invoice) {
    // Payment received! Handle success
    console.log('Payment complete:', invoice);
    // window.location.href = '/thank-you?order=' + invoice.external_id;
  }
});
<\/script>`;

  document.querySelector('#generated-code code').textContent = code;

  // Update preview
  updatePreview(options);
}

function updatePreview(options) {
  var container = document.getElementById('preview-container');
  container.innerHTML = '';

  SHKeeper.createButton(container, {
    amount: options.amount,
    currency: 'USD',
    crypto: options.crypto,
    buttonText: options.buttonText,
    orderId: 'preview-' + Date.now(),
    onSuccess: function(data) {
      console.log('Preview payment created:', data);
    }
  });
}

function copyCode(elementId) {
  var codeEl = document.querySelector('#' + elementId + ' code');
  var text = codeEl ? codeEl.textContent : document.getElementById(elementId).textContent;

  navigator.clipboard.writeText(text).then(function() {
    alert('Code copied to clipboard!');
  }).catch(function(err) {
    // Fallback
    var textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Code copied to clipboard!');
  });
}

// Generate initial code on page load
document.addEventListener('DOMContentLoaded', function() {
  generateCode();
});
</script>
{% endblock %}
