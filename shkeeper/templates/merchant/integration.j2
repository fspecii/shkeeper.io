{% extends 'merchant/base.j2' %}

{% block title %}Integration{% endblock %}
{% block page_title %}Widget Integration{% endblock %}

{% block content %}
<div class="torpay-grid torpay-grid-2">
  <!-- Left Column -->
  <div>
    <!-- Widget Generator -->
    <div class="torpay-card torpay-animate" style="margin-bottom: 2rem; animation-delay: 0.1s;">
      <div class="torpay-card-header">
        <h2 class="torpay-card-title">Payment Widget Generator</h2>
      </div>
      <div class="torpay-card-body">
        <p style="color: var(--torpay-gray-500); font-size: 0.875rem; margin-bottom: 1.5rem;">
          Configure your payment button and copy the generated code.
        </p>

        <div class="torpay-form-group">
          <label class="torpay-form-label">Amount (USD)</label>
          <input type="number" id="widget-amount" class="torpay-form-input" value="99.99" min="0.01" step="0.01">
        </div>

        <div class="torpay-form-group">
          <label class="torpay-form-label">Cryptocurrency</label>
          <select id="widget-crypto" class="torpay-form-input">
            {% for crypto in cryptos %}
            <option value="{{ crypto }}" {% if crypto == 'BTC' %}selected{% endif %}>{{ crypto }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="torpay-form-group">
          <label class="torpay-form-label">Button Text (Optional)</label>
          <input type="text" id="widget-text" class="torpay-form-input" placeholder="Leave empty for default: Pay $XX.XX">
        </div>

        <div class="torpay-form-group">
          <label class="torpay-form-label">Callback URL (Optional)</label>
          <input type="url" id="widget-callback" class="torpay-form-input" placeholder="https://your-site.com/webhook">
        </div>

        <button class="torpay-btn torpay-btn-primary" onclick="generateCode()" style="width: 100%;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 18 22 12 16 6"/>
            <polyline points="8 6 2 12 8 18"/>
          </svg>
          Generate Code
        </button>
      </div>
    </div>

    <!-- Quick Integration -->
    <div class="torpay-card torpay-animate" style="animation-delay: 0.2s;">
      <div class="torpay-card-header">
        <h2 class="torpay-card-title">Quick Start</h2>
      </div>
      <div class="torpay-card-body">
        <p style="color: var(--torpay-gray-500); font-size: 0.875rem; margin-bottom: 1.5rem;">
          Add these two snippets to any page to enable TorPay payments.
        </p>

        <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">1. Add the script (once per page)</h3>
        <div class="torpay-code-block" id="script-tag" style="margin-bottom: 1rem;">
<pre style="margin: 0; color: #e2e8f0;">&lt;script src="{{ base_url }}/static/js/torpay.js"&gt;&lt;/script&gt;</pre>
        </div>
        <button class="torpay-btn torpay-btn-secondary torpay-btn-sm torpay-copy-btn" onclick="copyCode('script-tag', this)" style="margin-bottom: 1.5rem;">Copy</button>

        <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">2. Initialize TorPay</h3>
        <div class="torpay-code-block" id="init-code">
<pre style="margin: 0; color: #e2e8f0;">&lt;script&gt;
TorPay.init({
  apiKey: '<span style="color: #a78bfa;">{{ merchant.api_key }}</span>',
  baseUrl: '{{ base_url | replace("http://", "https://") }}'
});
&lt;/script&gt;</pre>
        </div>
        <button class="torpay-btn torpay-btn-secondary torpay-btn-sm torpay-copy-btn" onclick="copyCode('init-code', this)" style="margin-top: 1rem;">Copy</button>
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div>
    <!-- Live Preview -->
    <div class="torpay-card torpay-animate" style="margin-bottom: 2rem; animation-delay: 0.15s;">
      <div class="torpay-card-header">
        <h2 class="torpay-card-title">Live Preview</h2>
      </div>
      <div class="torpay-card-body" style="display: flex; align-items: center; justify-content: center; min-height: 120px; background: var(--torpay-gray-50);">
        <div id="preview-container"></div>
      </div>
    </div>

    <!-- Generated Code -->
    <div class="torpay-card torpay-animate" style="animation-delay: 0.25s;">
      <div class="torpay-card-header">
        <h2 class="torpay-card-title">Generated Code</h2>
        <button class="torpay-btn torpay-btn-primary torpay-btn-sm torpay-copy-btn" onclick="copyCode('generated-code', this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          Copy
        </button>
      </div>
      <div class="torpay-card-body" style="padding: 0;">
        <div class="torpay-code-block" id="generated-code" style="border-radius: 0; max-height: 350px; overflow-y: auto;">
<pre style="margin: 0; color: #e2e8f0;"><!-- Code will appear here --></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Full Example -->
<div class="torpay-card torpay-animate" style="margin-top: 2rem; animation-delay: 0.35s;">
  <div class="torpay-card-header">
    <h2 class="torpay-card-title">Complete HTML Example</h2>
    <button class="torpay-btn torpay-btn-secondary torpay-btn-sm torpay-copy-btn" onclick="copyCode('full-example', this)">Copy Full Example</button>
  </div>
  <div class="torpay-card-body" style="padding: 0;">
    <div class="torpay-code-block" id="full-example" style="border-radius: 0;">
<pre style="margin: 0; color: #e2e8f0; font-size: 0.75rem;">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Checkout - Your Store&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Complete Your Purchase&lt;/h1&gt;
  &lt;p&gt;Order Total: $99.99&lt;/p&gt;

  &lt;!-- TorPay Payment Button --&gt;
  &lt;div id="torpay-button"&gt;&lt;/div&gt;

  &lt;script src="{{ base_url }}/static/js/torpay.js"&gt;&lt;/script&gt;
  &lt;script&gt;
    TorPay.init({
      apiKey: '<span style="color: #a78bfa;">{{ merchant.api_key }}</span>',
      baseUrl: '{{ base_url | replace("http://", "https://") }}'
    });

    TorPay.createButton('#torpay-button', {
      amount: 99.99,
      currency: 'USD',
      crypto: 'BTC',
      orderId: 'ORDER-123',

      onPaymentComplete: function(invoice) {
        window.location.href = '/thank-you?order=' + invoice.external_id;
      }
    });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
    </div>
  </div>
</div>

<!-- Advanced Options -->
<div class="torpay-card torpay-animate" style="margin-top: 2rem; animation-delay: 0.45s;">
  <div class="torpay-card-header">
    <h2 class="torpay-card-title">Advanced: Programmatic Payments</h2>
  </div>
  <div class="torpay-card-body">
    <p style="color: var(--torpay-gray-500); font-size: 0.875rem; margin-bottom: 1.5rem;">
      For more control, you can create payments programmatically.
    </p>
    <div class="torpay-code-block">
<pre style="margin: 0; color: #e2e8f0; font-size: 0.75rem;"><span style="color: #94a3b8;">// Open payment modal directly</span>
document.getElementById('my-checkout-btn').addEventListener('click', function() {
  TorPay.openPaymentModal({
    amount: getCartTotal(),
    currency: 'USD',
    crypto: 'BTC',
    orderId: generateOrderId(),

    onSuccess: function(invoice) {
      console.log('Invoice:', invoice.id);
      console.log('Send to:', invoice.dest);
    },

    onPaymentComplete: function(invoice) {
      submitOrder(invoice);
    },

    onError: function(error) {
      console.error('Payment failed:', error);
    }
  });
});

<span style="color: #94a3b8;">// Or create payment via API and handle UI yourself</span>
TorPay.createPayment({
  amount: 99.99,
  currency: 'USD',
  crypto: 'BTC',
  orderId: 'order-123'
}, function(error, invoice) {
  if (error) return console.error(error);
  showPaymentAddress(invoice.dest);
  showQRCode(invoice.qr_url);
  startPollingForPayment(invoice.id);
});</pre>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/torpay.js') }}"></script>
<script>
// Available cryptos from database
var availableCryptos = {{ cryptos | tojson }};

TorPay.init({
  apiKey: '{{ merchant.api_key }}',
  baseUrl: '{{ base_url | replace("http://", "https://") }}'
});

function generateCode() {
  var amount = document.getElementById('widget-amount').value;
  var buttonText = document.getElementById('widget-text').value;
  var callback = document.getElementById('widget-callback').value;

  // Format cryptos array for code display
  var cryptosStr = JSON.stringify(availableCryptos);

  var code = `<!-- TorPay Payment Button -->
<div id="torpay-button"></div>

<script src="{{ base_url }}/static/js/torpay.js"><\/script>
<script>
TorPay.init({
  apiKey: '{{ merchant.api_key }}',
  baseUrl: '{{ base_url | replace("http://", "https://") }}'
});

TorPay.createButton('#torpay-button', {
  amount: ${amount},
  currency: 'USD',
  cryptos: ${cryptosStr}${buttonText ? `,
  buttonText: '${buttonText}'` : ''}${callback ? `,
  callbackUrl: '${callback}'` : ''},

  onPaymentComplete: function(invoice) {
    console.log('Payment complete:', invoice);
  }
});
<\/script>`;

  document.querySelector('#generated-code pre').textContent = code;
  updatePreview({ amount: parseFloat(amount), buttonText: buttonText });
}

function updatePreview(options) {
  var container = document.getElementById('preview-container');
  container.innerHTML = '';
  TorPay.createButton(container, {
    amount: options.amount,
    currency: 'USD',
    // Use available cryptos from DB - default to first one (usually BTC)
    cryptos: availableCryptos,
    buttonText: options.buttonText,
    orderId: 'preview-' + Date.now(),
    onSuccess: function(data) { console.log('Preview created:', data); }
  });
}

function copyCode(elementId, button) {
  var el = document.getElementById(elementId);
  var pre = el.querySelector('pre');
  var text = pre ? pre.textContent : el.textContent;

  navigator.clipboard.writeText(text).then(function() {
    if (button) {
      button.classList.add('copied');
      setTimeout(function() { button.classList.remove('copied'); }, 2000);
    }
  });
}

document.addEventListener('DOMContentLoaded', generateCode);
</script>
{% endblock %}
